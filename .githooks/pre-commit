#!/usr/bin/env bash
# Pre-commit hook: scan staged files for secrets/credentials
# Install: ./setup-hooks.sh

set -euo pipefail

RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Files to skip (false positive prone)
SKIP_FILES=".p10k.zsh"

# Get staged files (exclude deleted files and binaries)
staged_files=$(git diff --cached --name-only --diff-filter=d 2>/dev/null) || exit 0

if [[ -z "$staged_files" ]]; then
    exit 0
fi

found_secrets=0

while IFS= read -r file; do
    # Skip files in skip list
    basename=$(basename "$file")
    if [[ "$SKIP_FILES" == *"$basename"* ]]; then
        continue
    fi

    # Skip binary files
    if file --mime-encoding "$file" 2>/dev/null | grep -q "binary"; then
        continue
    fi

    # Skip if file doesn't exist (shouldn't happen with --diff-filter=d but just in case)
    [[ -f "$file" ]] || continue

    # Get only staged content
    content=$(git show ":$file" 2>/dev/null) || continue

    line_num=0
    while IFS= read -r line; do
        ((line_num++)) || true

        # Skip lines with nosecret exemption
        if [[ "$line" == *"# nosecret"* ]] || [[ "$line" == *"// nosecret"* ]]; then
            continue
        fi

        matched=""

        # AWS access keys (AKIA followed by 16 alphanumeric chars)
        if echo "$line" | grep -qP -- 'AKIA[0-9A-Z]{16}'; then
            matched="AWS Access Key"
        # GitHub PATs
        elif echo "$line" | grep -qP -- '(ghp_[a-zA-Z0-9]{36}|github_pat_[a-zA-Z0-9_]{82}|gho_[a-zA-Z0-9]{36}|ghs_[a-zA-Z0-9]{36})'; then
            matched="GitHub Token"
        # OpenAI / Stripe keys
        elif echo "$line" | grep -qP -- 'sk-[a-zA-Z0-9]{20,}'; then
            matched="API Secret Key (OpenAI/Stripe)"
        # Slack tokens
        elif echo "$line" | grep -qP -- 'xox[bporas]-[a-zA-Z0-9-]+'; then
            matched="Slack Token"
        # Private key headers
        elif echo "$line" | grep -qP -- '-----BEGIN\s+(RSA|DSA|EC|OPENSSH|PGP)?\s*PRIVATE KEY-----'; then
            matched="Private Key"
        # Generic secret assignments: password/api_key/secret/token = "..."
        elif echo "$line" | grep -qPi -- '(password|api_key|apikey|secret_key|secret|token|auth_token)\s*[=:]\s*["\x27][^\s"'\'']{8,}'; then
            matched="Hardcoded Secret"
        # Exported tokens/secrets
        elif echo "$line" | grep -qPi -- 'export\s+\w*(TOKEN|SECRET|PASSWORD|API_KEY|APIKEY)\w*\s*=\s*["\x27]?[^\s"'\''#]{8,}'; then
            matched="Exported Secret"
        fi

        if [[ -n "$matched" ]]; then
            if [[ $found_secrets -eq 0 ]]; then
                echo -e "${RED}=== Secret Scanner: Potential secrets detected! ===${NC}"
                echo ""
            fi
            echo -e "${YELLOW}  $file:$line_num${NC} â€” $matched"
            # Show truncated line for context
            truncated=$(echo "$line" | head -c 80)
            echo "    $truncated..."
            echo ""
            found_secrets=1
        fi
    done <<< "$content"
done <<< "$staged_files"

if [[ $found_secrets -eq 1 ]]; then
    echo -e "${RED}Commit blocked.${NC} Remove secrets or add ${YELLOW}# nosecret${NC} to exempt specific lines."
    exit 1
fi

exit 0
